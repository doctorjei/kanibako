#!/usr/bin/env bash
set -euo pipefail

### Remove clodbox and its supporting files.

# Load shared library from the same directory as this script.
. "$(dirname "$(realpath "$0")")/clodbox-lib"

printf "Deleting configuration file (clodbox.rc)... "
if [ -e "$CLODBOX_CONFIG_FILE" ]; then
    . "$CLODBOX_CONFIG_FILE"
    rm -f "$CLODBOX_CONFIG_FILE"
    rmdir --ignore-fail-on-non-empty "$XDG_CONFIG_HOME/clodbox" 2>/dev/null || true
else
    CLODBOX_RELATIVE_STD_PATH="clodbox"
fi
printf "done.\n"

CLODBOX_DATA=$(_get_abspath_ "${XDG_DATA_HOME:-}" "$HOME/.local/share")/"$CLODBOX_RELATIVE_STD_PATH"

# Remove cron job
printf "Removing credential refresh cron job... "
CRON_CMD="$HOME/.local/bin/clodbox-refresh-credentials"
( crontab -l 2>/dev/null | grep -v "$CRON_CMD" || true ) | crontab -
printf "done.\n"

# Remove script files
printf "Removing executables... "
rm -f "$HOME/.local/bin/clodbox"
rm -f "$HOME/.local/bin/clodbox-config"
rm -f "$HOME/.local/bin/clodbox-archive"
rm -f "$HOME/.local/bin/clodbox-clean"
rm -f "$HOME/.local/bin/clodbox-restore"
rm -f "$HOME/.local/bin/clodbox-lib"
rm -f "$HOME/.local/bin/clodbox-lib-common"
rm -f "$HOME/.local/bin/clodbox-refresh-credentials"
rm -f "$HOME/.local/bin/clodbox-remove"
printf "done.\n"

printf "\nNote: Project and credential data remain in %s; to delete run the following command:\n\n" "$CLODBOX_DATA"
printf "  rm -rf %s\n\n" "$CLODBOX_DATA"
