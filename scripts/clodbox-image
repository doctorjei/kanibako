#!/usr/bin/env bash
set -euo pipefail

# List available container images.

# Load shared library
. "$(dirname "$(realpath "$0")")/clodbox-lib-common"

_usage_() {
  echo "Usage: clodbox image"
  echo ""
  echo "List available container images (built-in variants, local, and remote)."
  echo ""
  echo "Options:"
  echo "  -p, --project DIR  Show current image for a specific project"
  echo "  -h, --help         Show this help message"
}

case "${1:-}" in -h|--help) _usage_; exit 0 ;; esac

_clodbox_load_std_paths_
_clodbox_fetch_project_paths_

# ---- Built-in Variants ----
# Descriptions for known Containerfile variants.
declare -A VARIANT_DESCRIPTIONS=(
  [base]="Python, nano, git, jq, ssh, gh, archives"
  [systems]="C/C++, Rust, assemblers, QEMU, debuggers"
  [jvm]="Java, Kotlin, Maven"
  [android]="JVM + Gradle, Android SDK"
  [ndk]="Android + systems toolchain"
  [dotnet]=".NET SDK 8.0"
  [behemoth]="All toolchains combined"
)

containers_dir="$CLODBOX_DATA_PATH/containers"
found_variants=0

if [ -d "$containers_dir" ]; then
  for cf in "$containers_dir"/Containerfile.*; do
    [ -f "$cf" ] || continue
    variant="${cf##*.}"
    if [ $found_variants -eq 0 ]; then
      echo "Built-in image variants:"
      found_variants=1
    fi
    desc="${VARIANT_DESCRIPTIONS[$variant]:-}"
    if [ -n "$desc" ]; then
      printf "  %-12s %s\n" "$variant" "$desc"
    else
      printf "  %-12s (no description)\n" "$variant"
    fi
  done
fi

if [ $found_variants -eq 0 ]; then
  echo "Built-in image variants: (none installed — run clodbox-install first)"
fi

echo ""

# ---- Local Images ----
docker="${CLODBOX_DOCKER_CMD:-$(command -v podman 2>/dev/null || command -v docker 2>/dev/null || true)}"

if [ -n "$docker" ]; then
  echo "Local images:"
  local_images=$("$docker" images --format '{{.Repository}}:{{.Tag}}\t{{.Size}}' 2>/dev/null | grep -i clodbox || true)
  if [ -n "$local_images" ]; then
    while IFS=$'\t' read -r repo size; do
      printf "  %-50s %s\n" "$repo" "$size"
    done <<< "$local_images"
  else
    echo "  (none)"
  fi
else
  echo "Local images: (no container runtime found)"
fi

echo ""

# ---- Remote Registry Images ----
# Extract owner from CLODBOX_CONTAINER_IMAGE (e.g., ghcr.io/doctorjei/clodbox-base:latest → doctorjei)
registry_image="${CLODBOX_CONTAINER_IMAGE:-}"
owner=""

if [[ "$registry_image" == ghcr.io/* ]]; then
  # Strip ghcr.io/ prefix, then extract the first path component
  remainder="${registry_image#ghcr.io/}"
  owner="${remainder%%/*}"
fi

echo "Remote registry images:"
if [ -n "$owner" ] && command -v curl >/dev/null 2>&1; then
  api_url="https://api.github.com/users/${owner}/packages?package_type=container"
  response=$(curl -sS --max-time 10 "$api_url" 2>/dev/null || true)
  if [ -n "$response" ]; then
    packages=$(echo "$response" | \
      grep -o '"name"[[:space:]]*:[[:space:]]*"[^"]*clodbox[^"]*"' | \
      sed 's/"name"[[:space:]]*:[[:space:]]*"//; s/"$//' || true)
    if [ -n "$packages" ]; then
      while IFS= read -r pkg; do
        echo "  ghcr.io/${owner}/${pkg}"
      done <<< "$packages"
    else
      echo "  (no clodbox packages found for ${owner})"
    fi
  else
    echo "  (could not reach GitHub API)"
  fi
else
  if [ -z "$owner" ]; then
    echo "  (registry owner not detected from image: ${registry_image:-unset})"
  else
    echo "  (curl not available)"
  fi
fi

echo ""

# ---- Current Image ----
echo "Current image: $CLODBOX_CONTAINER_IMAGE"
