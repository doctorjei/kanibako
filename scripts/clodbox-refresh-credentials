#!/usr/bin/env bash
set -euo pipefail

# Refresh the clodbox central credential store from host credentials.
# Intended to be run via cron (e.g., every 6 hours).

# Load shared library from the same directory as this script.
. "$(dirname "$(realpath "$0")")/clodbox-lib"

# Load config to get paths.
if [ ! -f "$CLODBOX_CONFIG_FILE" ]; then
  echo "Error: [$CLODBOX_CONFIG_FILE] is missing. Reinstall to fix." >&2
  exit 1
fi
. "$CLODBOX_CONFIG_FILE"

XDG_DATA_HOME=$(_get_abspath_ "${XDG_DATA_HOME:-}" "$HOME/.local/share")
CLODBOX_DATA_PATH="$XDG_DATA_HOME/$CLODBOX_RELATIVE_STD_PATH"
CLODBOX_CREDENTIALS_PATH="$CLODBOX_DATA_PATH/$CLODBOX_INIT_CREDENTIALS_PATH"
CLODBOX_DOT_TEMPLATE_PATH="$CLODBOX_CREDENTIALS_PATH/$CLODBOX_DOT_PATH"

HOST_CREDS="$HOME/.claude/.credentials.json"

# Refresh credentials file (only if host copy is newer).
if [ -f "$HOST_CREDS" ]; then
  _cp_if_newer_ "$HOST_CREDS" "$CLODBOX_DOT_TEMPLATE_PATH/.credentials.json"
fi
