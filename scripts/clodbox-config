#!/usr/bin/env bash
set -euo pipefail

# Get or set per-project configuration.

# Load shared library
. "$(dirname "$(realpath "$0")")/clodbox-lib-common"

_usage_() {
  echo "Usage: clodbox config <key> [value]"
  echo ""
  echo "Get or set per-project configuration values."
  echo ""
  echo "Arguments:"
  echo "  <key>       Configuration key to read or write"
  echo "  [value]     New value to set (omit to read current value)"
  echo ""
  echo "Keys:"
  echo "  image       Container image for this project"
  echo ""
  echo "Options:"
  echo "  -p, --project DIR  Target a specific project directory"
  echo "  -h, --help         Show this help message"
}

case "${1:-}" in -h|--help) _usage_; exit 0 ;; esac

_clodbox_load_std_paths_
_clodbox_fetch_project_paths_

# Get or set configuration
key="${1:-}"
if [ -z "$key" ]; then
  _usage_ >&2
  exit 1
fi

case "$key" in
  image)
    if [ -z "${2:-}" ]; then
      echo "$CLODBOX_CONTAINER_IMAGE"
    else
      rc="$PROJECT_SETTINGS_PATH/project.rc"
      if [ -f "$rc" ] && grep -q '^CLODBOX_CONTAINER_IMAGE=' "$rc"; then
        sed -i "s|^CLODBOX_CONTAINER_IMAGE=.*|CLODBOX_CONTAINER_IMAGE=\"$2\"|" "$rc"
      else
        echo "CLODBOX_CONTAINER_IMAGE=\"$2\"" >> "$rc"
      fi
      echo "Set image to $2 for project $PROJECT_PATH"
    fi
    ;;
  *)
    echo "Error: Unknown config key: $key" >&2
    exit 1
    ;;
esac
