#!/usr/bin/env bash
set -euo pipefail

# Archive project session data and git metadata.

# Load shared library
. "$(dirname "$(realpath "$0")")/clodbox-lib-common"

project_path="${1:-}"
archive_file="${2:-}"

if [ -z "$project_path" ]; then
  echo "Error: Project path required." >&2
  echo "Usage: clodbox archive <project-path> [archive-file]" >&2
  exit 1
fi

# Override project dir and load paths
CLODBOX_PROJECT_DIR="$project_path"
_clodbox_load_std_paths_
_clodbox_fetch_project_paths_

# Check if session data exists
if [ ! -d "$PROJECT_SETTINGS_PATH" ]; then
  echo "Error: No session data found for project $PROJECT_PATH" >&2
  exit 1
fi

# Generate default archive filename if not provided
if [ -z "$archive_file" ]; then
  basename=$(basename "$PROJECT_PATH")
  hash8="${PROJECT_HASH:0:8}"
  timestamp=$(date -u +%Y%m%dT%H%M%SZ)
  archive_file="clodbox-${basename}-${hash8}-${timestamp}.txz"
fi

# Prepare metadata
info_file="$PROJECT_SETTINGS_PATH/clodbox-archive-info.txt"
echo "Project path: $PROJECT_PATH" > "$info_file"
echo "Project hash: $PROJECT_HASH" >> "$info_file"
echo "Archive date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$info_file"
echo "" >> "$info_file"

# Check if project is a git repo
if [ -d "$PROJECT_PATH/.git" ]; then
  cd "$PROJECT_PATH"

  # Check for uncommitted changes unless allowed
  if [ -z "${CLODBOX_ALLOW_UNCOMMITTED:-}" ]; then
    if ! git diff-index --quiet HEAD -- 2>/dev/null; then
      echo "Error: Uncommitted changes detected." >&2
      echo "Commit your changes or use --allow-uncommitted to override." >&2
      rm -f "$info_file"
      exit 1
    fi
  fi

  # Check for unpushed commits unless allowed
  if [ -z "${CLODBOX_ALLOW_UNPUSHED:-}" ]; then
    branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
    upstream=$(git rev-parse --abbrev-ref @{upstream} 2>/dev/null || echo "")
    if [ -n "$upstream" ]; then
      unpushed=$(git rev-list "$upstream..HEAD" --count 2>/dev/null || echo "0")
      if [ "$unpushed" -gt 0 ]; then
        echo "Error: $unpushed unpushed commit(s) detected." >&2
        echo "Push your changes or use --allow-unpushed to override." >&2
        rm -f "$info_file"
        exit 1
      fi
    fi
  fi

  # Record git metadata
  echo "Git repository: yes" >> "$info_file"
  echo "Branch: $(git rev-parse --abbrev-ref HEAD)" >> "$info_file"
  echo "Commit: $(git rev-parse HEAD)" >> "$info_file"
  echo "Remotes:" >> "$info_file"
  git remote -v | grep '(fetch)' | awk '{print "  " $1 ": " $2}' >> "$info_file"
else
  echo "Warning: No git repository detected in $PROJECT_PATH" >&2
  echo "Only clodbox session data will be archived." >&2
  echo "" >> "$info_file"
  echo "Git repository: no" >> "$info_file"
fi

# Create archive
printf "Creating archive %s... " "$archive_file"
tar -cJf "$archive_file" -C "$CLODBOX_DATA_PATH/$CLODBOX_PROJECTS_PATH" "$PROJECT_HASH"
rm -f "$info_file"
printf "done.\n"
echo "Archive created: $archive_file"
