#!/usr/bin/env bash
set -euo pipefail

### Install and set up clodbox.

# Load shared library from the same directory as this script.
. "$(dirname "$(realpath "$0")")/clodbox-lib"
mkdir -p "$XDG_CONFIG_HOME/clodbox"

_config_defaults='#!/usr/bin/env bash
export CLODBOX_RELATIVE_STD_PATH="clodbox"
export CLODBOX_INIT_CREDENTIALS_PATH="credentials"
export CLODBOX_PROJECTS_PATH="projects"

export CLODBOX_DOT_PATH="dotclod"
export CLODBOX_CFG_FILE="dotclod.json"
export CLODBOX_CONTAINER_IMAGE="ghcr.io/doctorjei/clodbox-base:latest"'

# Write out a default config file and load it into this script as well.
printf "Writing to general configuration file (clodbox.rc)... "
printf '%s\n' "$_config_defaults" > "$CLODBOX_CONFIG_FILE"
eval "$_config_defaults"
printf "done!\n"

# Process credential locations
CLODBOX_DATA=$(_get_abspath_ "${XDG_DATA_HOME:-}" "$HOME/.local/share")/"$CLODBOX_RELATIVE_STD_PATH"
CLODBOX_CREDENTIALS_PATH="$CLODBOX_DATA/$CLODBOX_INIT_CREDENTIALS_PATH"
CLODBOX_DOT_TEMPLATE_PATH="$CLODBOX_CREDENTIALS_PATH/$CLODBOX_DOT_PATH"
CLODBOX_CFG_TEMPLATE_FILE="$CLODBOX_CREDENTIALS_PATH/$CLODBOX_CFG_FILE"
SETTINGS_FILTER='{oauthAccount, hasCompletedOnboarding: true, installMethod}'

# Clone credentials into clodbox store
printf "Copying authentication credentials to clodbox store... "
mkdir -p "$CLODBOX_DOT_TEMPLATE_PATH"
jq "$SETTINGS_FILTER" "$HOME/.claude.json" > "$CLODBOX_CFG_TEMPLATE_FILE"
cp "$HOME/.claude/.credentials.json" "$CLODBOX_DOT_TEMPLATE_PATH"
printf "done!\n"

# Copy Containerfiles into clodbox data directory.
printf "Installing Containerfiles... "
mkdir -p "$CLODBOX_DATA/containers"
cp ./containers/Containerfile.base "$CLODBOX_DATA/containers/"
cp ./containers/Containerfile.behemoth "$CLODBOX_DATA/containers/"
printf "done!\n"

# Build base container image if it doesn't already exist.
docker="${CLODBOX_DOCKER_CMD:-$(command -v podman 2>/dev/null || command -v docker 2>/dev/null)}"
if [ -n "$docker" ]; then
  if ! "$docker" image exists localhost/clodbox:latest 2>/dev/null \
     && ! "$docker" image inspect localhost/clodbox:latest >/dev/null 2>&1; then
    printf "Building base container image (localhost/clodbox:latest)...\n"
    "$docker" build -t localhost/clodbox:latest \
      -f "$CLODBOX_DATA/containers/Containerfile.base" \
      "$CLODBOX_DATA/containers/"
    printf "Base image built!\n"
  else
    printf "Base container image already exists, skipping build.\n"
  fi
else
  printf "Warning: No container runtime (podman/docker) found; skipping image build.\n"
fi

# Copy executables and library into ~/.local/bin.
printf "Installing executables... "
cp "./clodbox-lib" "$HOME/.local/bin"
for script in clodbox clodbox-remove clodbox-refresh-credentials; do
  cp "./$script" "$HOME/.local/bin"
  chmod "+x" "$HOME/.local/bin/$script"
done
printf "done!\n"

# Install cron job to refresh credentials every 6 hours.
printf "Installing credential refresh cron job... "
CRON_CMD="$HOME/.local/bin/clodbox-refresh-credentials"
CRON_ENTRY="0 */6 * * * $CRON_CMD"
# Remove any existing clodbox cron entry, then append the new one.
( crontab -l 2>/dev/null | grep -v "$CRON_CMD" || true; echo "$CRON_ENTRY" ) | crontab -
printf "done!\n"

