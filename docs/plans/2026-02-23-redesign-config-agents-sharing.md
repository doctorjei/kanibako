# Kanibako Redesign: Configuration, Agents, Templates, and Sharing

**Date:** 2026-02-23
**Status:** In progress — config restructure, dir renames, auth, templates, shared caches done; agents (deferred), README remaining

---

## Overview

kanibako maps important directories in a standardized way to facilitate
multi-agent and containerized work.

## Primary Folders

| Folder | Purpose |
|--------|---------|
| settings | Project settings (previously "kanibako") |
| vault | Files shared explicitly with container (with snapshots for files written by agent) |
| shell | Agent home path (readable outside, intended as "agent space" -- tools, etc.) |
| workspace | Files for the project itself |

The vault path is always optional.

## Container Layout

```
/home/agent           ...mapped from... --> shell           (container home directory; settings, tools, etc)
             |--workspace ...mapped from... --> workspace       (project itself)
             |--share-ro  ...mapped from... --> vault/share-ro  (read only space to deliver info to agent)
             |--share-rw  ...mapped from... --> vault/share-rw  (read-write space to pass info with agent)
```

Settings are not directly mounted, but may include data that are included in
various ways by different agents, along with metadata for the project.

---

## Configuration

Kanibako's config file is found here:

```
{config} = $XDG_CONFIG_HOME/kanibako.toml
```

The config's primary purpose is to define the paths for the kanibako settings
and data. The settings path must be absolute; other paths are relative to
`{data_path}` for general purposes.

```toml
[paths]
data_path    = "$XDG_DATA_HOME/kanibako" # Main settings / data path
agents       = "agents"                  # Agent settings
boxes        = "boxes"                   # Individual kanibako container (box) settings, by hash
project_toml = "project.toml"            # Individual project settings
shared       = "shared"                  # Data shared across account-centric projects
shell        = "shell"                   # Home directory path
templates    = "templates"               # Home directory (shell) templates
vault        = "vault"                   # Data-passing directory name
workspaces   = "workspaces"              # Path to workspaces (only applicable for working set)
ws_hints     = "working_sets.toml"       # Working sets hint file

[container]
image = "ghcr.io/doctorjei/kanibako-base:latest" # Default container image

[shared] # Globally shared folders; assumed relative to home directory unless absolute
cargo-git = ".cargo/git"
cargo-reg = ".cargo/registry"
go        = "go/pkg/mod"
gradle    = ".gradle/caches"
maven     = ".m2/repository"
npm       = ".cache/npm"
pip       = ".cache/pip"
pnpm      = ".local/share/pnpm/store"
uv        = ".cache/uv"
yarn      = ".cache/yarn"
```

### Design Principles

- Config file = "where to find things" (paths, mounts, image default)
- Data path = "the things themselves" (agent settings, templates, projects, caches)
- Single file in `$XDG_CONFIG_HOME/` (no subdirectory needed for one file)
- `[shared]` entries are mount configuration, not data, so they belong in the config

---

## Agents

Agents must be installed via plugin. The default, built-in "agent" is `/bin/sh`.

`kanibako-base` contains the hard-coded `no_agent` (runs `/bin/sh`) using the
"standard" shell template. The regular `kanibako` package also includes the
`claude` agent plugin.

### Naming Convention

Agent ID = TOML filename stem = template directory name = target plugin name.
`target_name = "claude"` selects both the target plugin and `agents/claude.toml`.

- `general` — the no-agent default (runs `/bin/sh`); has a real TOML file at
  `agents/general.toml` (initially empty, user can customize)
- `claude` — Claude Code; TOML generated by the claude target plugin

Agent settings files are per-agent, by name; the filename is used to derive the
ID. For example, `{agents}/claude.toml` contains the settings for agent with ID
"claude" (Claude Code). This is also used as the identifier for templates and
other purposes.

### TOML Creation

The target plugin generates its agent TOML on first use — it knows its own
defaults. `kanibako setup` also triggers generation for installed plugins.

### Schema

```toml
[agent]
name = "Claude Code"         # Display name
shell = "standard"           # Default template variant
default_args = []            # Always passed to agent binary

[state]
# model = "opus"             # Uncomment to override agent's model selection
access = "permissive"        # Permission / access level

[env]                        # Agent-level env vars (injected into container)

[shared]                     # Agent-level shared caches
plugins = ".claude/plugins"
```

### Section Roles

| Section | Role |
|---------|------|
| `[agent]` | Identity and defaults — universal fields every agent uses (name, default template variant, default CLI args) |
| `[state]` | Runtime behavior knobs — common but optional (model, access); agents that don't support a field ignore it; target plugin translates values into CLI args/env/config as needed |
| `[env]` | Raw env vars injected into container — agent-agnostic escape hatch, merged with per-project and global env vars |
| `[shared]` | Agent-level shared cache paths — same mechanism as global `[shared]` in kanibako.toml but stored separately (see Sharing Hierarchy) |

### Notes

- `model` is commented out by default. Users typically select the model
  interactively; uncomment to override at the CLI level.
- `default` is a reserved keyword for template variant, meaning "use the
  agent's configured default" (resolved at runtime). It is not a directory name.
- The target plugin is responsible for translating `[state]` values into
  whatever the agent needs (CLI args, env vars, config files).

---

## Templates

A template for the "shell" of an agent (home directory) is used to create each
project. The template "empty" always exists and is used as the fallback if there
are no other templates. (The empty template has no directory.)

### Naming

- Template variant ID = subdirectory name. `standard` → `templates/claude/standard/`.
- `default` is a reserved keyword meaning "use the agent's configured default
  template variant" (from `[agent] shell` in agent TOML). Not a directory name.
- `standard` is the shipped variant name (the one that comes with the package).

### Template Directory Layout

```
{templates}/general          # No-agent templates (agent ID = "general")
{templates}/general/base     # Common skeleton, applied under every non-empty template
{templates}/general/standard # Shipped general template
{templates}/claude           # Claude Code templates (from claude plugin package)
{templates}/claude/standard  # Shipped Claude template (prepared .claude/CLAUDE.md)
```

All templates (aside from "empty") are constructed *on top of* the "base"
template so that they have basic settings as needed.

### Template Contents

Templates are plain directory trees. Files are copied (via `shutil.copytree`
with `dirs_exist_ok=True`) into the shell directory. No variable substitution,
no special syntax — just files.

### Resolution Order

For a given agent name and template variant:

1. `{templates}/{agent_name}/{variant}/` (e.g. `templates/claude/standard/`)
2. `{templates}/general/{variant}/` (e.g. `templates/general/standard/`)
3. (none — "empty" template, no files applied)

### Layering

1. `general/base/*` → `shell_path/` (common skeleton)
2. Resolved template → `shell_path/` (overwrites base files if names collide)

### Init Flow

All agent-aware initialization happens in `start.py` after target resolution,
not in `_init_common()`. This keeps `_init_common()` purely kanibako
infrastructure.

```
_init_common()              paths.py     (1) mkdir shell, bootstrap .bashrc/.profile/.shell.d
                                         (no credentials, no templates)

resolve_target()            start.py     (2) identify agent
apply_shell_template()      start.py     (3) overlay template (if proj.is_new)
target.init_home()          start.py     (4) agent-specific setup (if proj.is_new)
runtime.run()               start.py     (5) launch
```

Steps 3-4 only run when `proj.is_new` and a target is resolved.

`target.init_home(home, auth=...)` handles agent-specific setup (credentials,
config files) and receives the auth mode so agents can skip credential copy
for distinct auth without skipping other initialization.

### Template Source

- `general/base` and `general/standard`: created during `kanibako setup`
  (initially empty or with minimal files)
- Agent-specific templates: shipped as package data by the target plugin
  (like containerfiles today). Installed on first use or via a setup step.
- Users customize by editing files in the template directories directly.

---

## Layouts

Three layouts available for all three modes: **simple**, **default**, and **robust**.

- **Simple** layout maximizes easy access; settings live inside the workspace
- **Default** layout is a middle ground
- **Robust** layout maximizes isolation of settings from agent

### Special Notes

1. Layout defines location of primary host folders.
2. Host folders, other than settings, may be overridden by user.
3. Layout and folder overrides are on a per-project basis.
4. We will also add overrides for shared data (specifics TBD).
5. It must be possible to migrate a project from one mode to another.
6. All paths -- overridden or otherwise -- should be stored in the project
   settings for consistency.
7. The layout should be stored in the project settings for each project, too.

### TODO

1. Add folder overrides.
2. Add layout overrides.
3. Design and implement sharing overrides.
4. Consider overrides to defaults, on a user-basis, for all projects created
   moving forward.

### Project Configuration and Shell Defaults

All modes define settings, workspace, vault, and shared (if applicable) paths
separately. Individual project configuration and shell locations default as
follows for all projects:

```
proj_toml <-- {settings}/{project_toml} [for simple, {workspace}/.{project_toml}]
shell     <-- {settings}/{shell}        [for simple, {workspace}/.{shell}]
```

Default and robust layouts are identical to the default for shell and project
configuration placement.

---

## Sharing Hierarchy

Global download caches (pip, cargo, npm, etc.) are safe to share broadly because
they are content-addressed or keyed by version/platform. Agent-level shared
resources (like `.claude/plugins`) may conflict between worksets or agents.

### Three Levels

| Level | Host path | Visible to | Source |
|-------|-----------|------------|--------|
| Truly global | `{data_path}/shared/global/{name}/` | All AC + all WS projects | `[shared]` in kanibako.toml |
| Agent (AC) | `{data_path}/shared/{agent_id}/{name}/` | AC projects using that agent | `[shared]` in agent TOML |
| Agent (WS) | `$worksetdir/shared/{agent_id}/{name}/` | WS projects using that agent | `[shared]` in agent TOML |

- **Truly global** caches (pip, cargo, npm, etc.) are mounted for all
  non-decentralized projects regardless of mode.
- **Agent-level** caches are never truly global. They route to
  `{data_path}/shared/{agent_id}/` in AC mode or
  `$worksetdir/shared/{agent_id}/` in WS mode. Agent subdirectories keep
  caches separate when a workset has projects with different agents.
- **Decentralized** projects get no shared caches.

### Lazy Creation

Shared directories are only created/mounted when they exist on the host side
(lazy creation, not eager). Users opt in by creating the directory.

---

## Mode 1: Account-Centric (default)

Centralized store for settings (except in simple mode). Vault is located in
project directory and mounted with empty tmpfs (except in robust mode). Default
is a reasonably secure middle ground between simple and robust.

### Critical Paths

```
settings  <-- {boxes}/{project_hash}
workspace <-- {project_dir}
shared    <-- {data_path}/{shared}/global        (truly global caches)
              {data_path}/{shared}/{agent_id}    (agent-level caches)
vault     <-- {workspace}/{vault}       [for robust, {settings}/{vault}]
```

### Robust Layout Vault Symlink

For account-centric robust layout, vault storage uses hashes which aren't
human-friendly. To help the user:

```
{data_path}/{vault}/{project_basename} ...symlink to... {settings}/{vault}
```

If there is a conflict for the basename, a decimal number is appended (bob,
bob1, bob2, bob3, etc.).

When a user opts for robust layout with account-centric mode, display:

> NOTE: In robust layout, the account-centric vault is linked from
> `{data_path}/{vault}`. You can create a symlink from your home directory
> with: `ln -s {data_path}/{vault} $HOME/kanibako_vault`

### Pros/Cons

- (+) Just activate in project path (`kanibako`, `kanibako start`, `kanibako box new`)
- (-) Vault and other settings visible to agent in some modes
- (-) Unless migrated properly, path change causes failure to locate settings
- (-) In robust layout, storage area must use path hashes to avoid collisions

---

## Mode 2: Working Set

Group store (e.g., `~/kaniprojs/{agents,boxes,shared,vault,workspaces}/projname`).
Default layout is identical to robust layout.

### Critical Paths

```
ws_config <-- $worksetdir/workingset.toml
settings  <-- $worksetdir/{boxes}/project_name
workspace <-- $worksetdir/{workspaces}/project_name
shared    <-- {data_path}/{shared}/global            (truly global caches)
              $worksetdir/{shared}/{agent_id}         (agent-level caches)
vault     <-- $worksetdir/{vault}/proj_name [in simple, $workspace/{vault}]
```

If a project with a specific name already exists, trying to recreate should
throw an error ("already exists").

### Pros/Cons

- (+) Clear separation of vault, settings, shell, and project workspace (invisible to agent)
- (+) Project name can be used instead of hashes (infrequent collisions)
- (+) Allows grouping by theme / purpose / etc.
- (+) Change of path within group store OK
- (-) Working set must be explicitly created (`kanibako workset create jenkins ./`)
- (-) Must open to start (`workset open jenkins`), close to stop (`workset close`)
- (-) Only one working set may be active at a time

---

## Mode 3: Decentralized

Single directory for all elements. Default layout is identical to simple layout.
Each project is self-contained -- a single directory holds the settings, vault,
and working copy. Completely portable but unintegrated.

### Critical Paths

```
settings  <-- {projectdir}/[.]?kanibako
workspace <-- {projectdir}              [for robust, {projectdir}/workspace]
vault     <-- {projectdir}/{vault}
```

No shared resources in decentralized mode.

### Pros/Cons

- (+) Can move individual projects at will
- (+) No question about "lost project files" or similar issues
- (-) Requires robust mode to avoid shell and vault files cluttering workspace
- (-) No way to group projects together
